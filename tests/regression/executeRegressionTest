
# Copyright 1999-2002 Carnegie Mellon University.  
# Portions Copyright 2002 Sun Microsystems, Inc.  
# Portions Copyright 2002 Mitsubishi Electronic Research Laboratories.
# All Rights Reserved.  Use is subject to license terms.
# 
# See the file "license.terms" for information on usage and
# redistribution of this file, and for a DISCLAIMER OF ALL 
# WARRANTIES.
#
# This script performs the highlevel coordination for the regression
# tests which includes building S4, runnng the tests, logging the
# results, putting the results out to CVS and performing email
# notification

regressionDir=`pwd`

echo regressionDir is $regressionDir while pwd is `pwd`
###################
# Since the scripts just came out of CVS, they may not
# be executable yet.  So make them executable
#
scripts="getTime mailReport makeReport parseLog regressionTest\
	runAllTests runTest s4_align s4_align_sum"

chmod +x $scripts

logBase=regression.log
logPath=$regressionDir/$logBase
rootDir=../../
#rootDir=/home/plamere/s4test/

#############################
# Log the metrics
#############################
# Collect the metrics first, before we muddy up the work space
#
cd $regressionDir
./collectMetrics >> $logPath

##########################
# then we build the world
##########################
cd $rootDir
date=`date +%D`
time=`date +%T`
machine=`hostname`
who=`whoami`

startBuildTime=`$regressionDir/getTime`
if gmake all
then
  status="OK";
else
  status="FAILED";
fi
endBuildTime=`$regressionDir/getTime`

#totalBuildTime=$((endBuildTime - startBuildTime))
totalBuildTime=`expr $endBuildTime - $startBuildTime`


#########################################
# If the build succeeded, run the tests
########################################
cd $regressionDir

if [ $status = "OK" ]; then
   startRunTime=`$regressionDir/getTime`
   $regressionDir/runAllTests
   endRunTime=`$regressionDir/getTime`
   # totalRunTime=$((endRunTime - startRunTime)) // a bash-ism
   totalRunTime=`expr $endRunTime - $startRunTime`
else
   echo build failure - tests not run
   totalRunTime="N/A"
fi

#############################
# Log the build information
#############################
echo "build|$date|$time|$machine|$who|make|$status|$totalBuildTime|$totalRunTime|" >> $logPath



#############################
# checkin the log
#############################
cd $regressionDir
scvs commit -m "regression_test" $logBase

#################################
# Generate the email notification
#################################
$regressionDir/mailReport


###############################
# Generate the regression test web page
#################################A
$regressionDir/pushReport
